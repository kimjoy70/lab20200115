package thread.bank;

import java.awt.FlowLayout;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.Socket;
import java.util.List;
import java.util.Map;
import java.util.Vector;

import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.JTextArea;
import javax.swing.table.DefaultTableModel;

public class CustomerBank extends JFrame {
	Socket mySocket = null;
	ObjectInputStream ois  = null;
	ObjectOutputStream oos = null;		
	String nickName = null;
	String ip = "127.0.0.1";
	int port = 3002;
	JTextArea jta_cus = new JTextArea(9,30);
	JScrollPane jsp_cus = new JScrollPane(jta_cus);
	String cols[] = {"계좌번호","잔액","예금주","ID"};
	String data[][] = new String[0][4];
	DefaultTableModel dtm_acc = new DefaultTableModel(data,cols);
	JTable jtb_acc = new JTable(dtm_acc);
	JScrollPane jsp_acc = new JScrollPane(jtb_acc);
	CustomerDao cusDao = new CustomerDao();
	JButton jbtn_search = new JButton("계좌조회");
	JButton jbtn_transfer = new JButton("계좌이체");
	JButton jbtn_deposit = new JButton("입금");
	JButton jbtn_contribution = new JButton("출금");
	JPanel jp_north = new JPanel();
	CustomerBank(){
		nickName = JOptionPane.showInputDialog("너의 대화명은?");
		if(nickName==null) {
			return;
		}
		initDisplay();
		setAccountBank();
		connect_process();
	}
	public void setAccountBank() {
		List<Map<String,Object>> baList = cusDao.getBankAccount("");
		while(dtm_acc.getRowCount()>0) {
			dtm_acc.removeRow(0);
		}
		for(int i=0;i<baList.size();i++) {
			Map<String,Object> rMap = baList.get(i);
			Vector<Object> v = new Vector<>();
			v.add(rMap.get("accountnumber"));
			v.add(rMap.get("balance"));
			v.add(rMap.get("mem_name"));
			v.add(rMap.get("mem_id"));
			dtm_acc.addRow(v);
		}		
	}
	public void initDisplay() {
		this.setTitle(nickName+"님의 대화창");
		jp_north.setLayout(new FlowLayout(FlowLayout.LEFT));
		jp_north.add(jbtn_search);
		jp_north.add(jbtn_transfer);
		jp_north.add(jbtn_deposit);
		jp_north.add(jbtn_contribution);
		this.add("Center",jsp_acc);
		this.add("North",jp_north);
		this.add("South",jsp_cus);
		this.setSize(500, 700);
		this.setVisible(true);		
	}
	public void connect_process() {
		this.setTitle(nickName+"님의 대화창");
		try {
			//통신은 지연될 수 있다.-wait - try...catch해야함.
			mySocket = new Socket(ip,port);
			oos = new ObjectOutputStream
					(mySocket.getOutputStream());			
			ois = new ObjectInputStream
						(mySocket.getInputStream());
			oos.writeObject(Protocol.ROOM_IN
				       +Protocol.seperator+nickName);			
			CustomerBankThread cbt = new CustomerBankThread(this);
			cbt.start();//TalkClientThread의 run호출됨.-콜백함수
		} catch (Exception e) {
			System.out.println(e.toString());//에러 힌트문 출력.
		}		
	}	
	public static void main(String[] args) {
		CustomerBank cus = new CustomerBank();
	}

}
